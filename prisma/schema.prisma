// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//Estado de diagnosticos
enum diagnosticState {
  ACTIVE
  ARCHIVED
  DELETED
}

enum DocCategory {
  GENERAL
  DIAGNOSTIC_ATTACHMENT
  LAB
}

// Tipos de órdenes médicas
enum MedicalOrderType {
  LABORATORY
  RADIOLOGY
}

// Estado de la orden
enum MedicalOrderStatus {
  DRAFT
  ORDERED
  COMPLETED
  CANCELLED
}

// Prioridad clínica
enum MedicalOrderPriority {
  ROUTINE
  URGENT
  STAT
}

enum DiagnosisType {
  PRIMARY
  SECONDARY
}

// Modelo para registros médicos
model MedicalRecord {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  patientId     String   @db.ObjectId
  physicianId   String   @db.ObjectId //doctor
  appointmentId String   @db.ObjectId //Relacion con la cita
  date          DateTime @default(now())
  symptoms      String
  diagnosis     String?
  treatment     String?
  notes         String?
  status        String   @default("active") // "active", "archived"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones virtuales para navegación en Prisma
  prescriptions Prescription[]
  labResults    LabResult[]
  documents     Document[]
  diagnostic    Diagnostics[]

  @@index([patientId])
  @@index([physicianId])
  @@index([appointmentId])
}

// Modelo para prescripciones
model Prescription {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  medicalRecordId  String    @db.ObjectId
  doctorId         String    @db.ObjectId
  diagnosticId     String?   @db.ObjectId
  patientId        String    @db.ObjectId
  medication       String
  dosage           String
  frequency        String
  duration         String
  instructions     String?
  prescriptionDate DateTime  @default(now())
  expirationDate   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
}

// Modelo para resultados de laboratorio
model LabResult {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  medicalRecordId String   @db.ObjectId
  testType        String
  result          String
  referenceRange  String?
  labName         String?
  testDate        DateTime
  resultDate      DateTime @default(now())
  comments        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relación con el registro médico
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
}

model DiseaseCatalog {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  code        String // p.ej. "J00"
  name        String // p.ej. "Rinitis aguda (resfriado común)"
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([code])
}

model Diagnostics {
  id              String @id @default(auto()) @map("_id") @db.ObjectId
  patientId       String @db.ObjectId
  doctorId        String @db.ObjectId
  medicalRecordId String @db.ObjectId

  // Relación con catálogo
  diseaseCode String // referencia a DiseaseCatalog.code
  diseaseName String // copia del nombre del catálogo para consulta rápida
  type        DiagnosisType @default(SECONDARY) // PRIMARY o SECONDARY

  // Campos narrativos (opcional, los puedes conservar)
  title           String
  description     String
  diagnosis       String // texto libre si quieres mantenerlo
  treatment       String
  observations    String?
  nextAppointment DateTime?

  state     diagnosticState @default(ACTIVE)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])
  documents     Document[]

  @@index([patientId])
  @@index([doctorId])
  @@index([medicalRecordId])
  @@index([diseaseCode])
}

model Document {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  diagnosticId    String      @db.ObjectId
  medicalRecordId String      @db.ObjectId
  patientId       String      @db.ObjectId
  category        DocCategory @default(GENERAL)
  filename        String //Nombre original del archivo
  storeFilename   String //Nombre del archivo en el almacenamiento
  filePath        String //Ruta del archivo en el almacenamiento
  fileType        String //pdf, jpg, png, etc.
  mimeType        String //application/pdf, image/jpeg, etc.
  fileSize        Int //Tamaño del archivo en bytes
  description     String?
  deleteAt        DateTime?
  uploadedBy      String      @db.ObjectId
  createdAt       DateTime    @default(now())

  //Relaciones
  diagnostic    Diagnostics   @relation(fields: [diagnosticId], references: [id], onDelete: Cascade)
  medicalRecord MedicalRecord @relation(fields: [medicalRecordId], references: [id])

  @@index([diagnosticId])
  @@index([patientId])
  @@index([category])
  @@index([medicalRecordId])
  @@index([deleteAt])
}

// Modelo para Órdenes Médicas
model MedicalOrder {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  patientId       String               @db.ObjectId
  doctorId        String               @db.ObjectId
  medicalRecordId String?              @db.ObjectId
  type            MedicalOrderType
  priority        MedicalOrderPriority @default(ROUTINE)
  status          MedicalOrderStatus   @default(ORDERED)
  notes           String?

  // Listas nativas en MongoDB
  labTests       String[] // para type=LABORATORY
  radiologyExams String[] // para type=RADIOLOGY

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
  @@index([doctorId])
  @@index([medicalRecordId])
  @@index([type])
  @@index([status])
}
